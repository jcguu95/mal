["do",

["load", ["`", "miniMAL-core.json"]],
["load", ["`", "types.json"]],
["load", ["`", "reader.json"]],
["load", ["`", "printer.json"]],
["load", ["`", "env.json"]],

["def", "READ", ["fn", ["strng"],
  ["read-str", "strng"]]],

["def", "LET", ["fn", ["env", "args"],
  ["if", [">", ["count", "args"], 0],
    ["do",
      ["env-set", "env", ["nth", "args", 0],
                         ["EVAL", ["nth", "args", 1], "env"]],
      ["LET", "env", ["rest", ["rest", "args"]]]]]]],

["def", "EVAL", ["fn", ["ast", "env"],
 ["do",
  ["let", ["debug-eval-sym", ["symbol", ["`", "DEBUG-EVAL"]],
           "debug-eval-env", ["env-find", "env", "debug-eval-sym"]],
    ["if", ["not", ["=", "debug-eval-env", null]],
      ["let", ["debug-eval", ["env-get", "debug-eval-env", "debug-eval-sym"]],
        ["if", ["not", ["or", ["=", "debug-eval", null],
                              ["=", "debug-eval", false]]],
          ["println", ["`", "EVAL:"], ["pr-str", "ast", true]]]]]],
  ["if", ["symbol?", "ast"],
    ["env-get", "env", "ast"],
  ["if", ["vector?", "ast"],
    ["vectorl", ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"]],
  ["if", ["map?", "ast"],
    ["let", ["new-hm", ["hash-map"]],
      ["do",
        ["map", ["fn", ["k"], ["set", "new-hm",
                                "k",
                                ["EVAL", ["get", "ast", "k"], "env"]]],
                ["keys", "ast"]],
        "new-hm"]],
  ["if", ["not", ["list?", "ast"]],
        "ast",
        ["if", ["empty?", "ast"],
          "ast",
          ["let", ["a0", ["get", ["first", "ast"], ["`", "val"]]],
            ["if", ["=", ["`", "def!"], "a0"],
              ["env-set", "env", ["nth", "ast", 1],
                                 ["EVAL", ["nth", "ast", 2], "env"]],
            ["if", ["=", ["`", "let*"], "a0"],
              ["let", ["let-env", ["env-new", "env"]],
                ["do",
                  ["LET", "let-env", ["nth", "ast", 1]],
                  ["EVAL", ["nth", "ast", 2], "let-env"]]],
              ["let", ["el", ["map", ["fn", ["x"], ["EVAL", "x", "env"]], "ast"],
                       "f", ["first", "el"],
                       "args", ["rest", "el"]],
                ["apply", "f", "args"]]]]]]]]]]]]],

["def", "PRINT", ["fn", ["exp"],
  ["pr-str", "exp", true]]],


["def", "repl-env", ["env-new"]],
["env-set", "repl-env", ["symbol", ["`", "+"]], "+"],
["env-set", "repl-env", ["symbol", ["`", "-"]], "-"],
["env-set", "repl-env", ["symbol", ["`", "*"]], "*"],
["def", "div", ["fn", ["a", "b"], ["parseInt", ["/", "a", "b"]]]],
["env-set", "repl-env", ["symbol", ["`", "/"]], "div"],

["def", "rep", ["fn", ["strng"],
  ["try",
    ["PRINT", ["EVAL", ["READ", "strng"], "repl-env"]],
    ["catch", "exc",
      ["str", ["`", "Error: "], [".", "exc", ["`", "toString"]]]]]]],

["repl", ["`", "user> "], "rep"],

null

]
